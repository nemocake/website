<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Collection | con.rad">
  <title>Collection | con.rad</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'mono': ['"JetBrains Mono"', 'monospace'],
            'sans': ['"Space Grotesk"', 'sans-serif'],
            'display': ['"Syne"', 'sans-serif'],
          },
          colors: {
            'acid': '#ccff00',
            'neon-blue': '#00f3ff',
            'void': '#050505',
            'glass': 'rgba(255, 255, 255, 0.05)',
            'glass-dark': 'rgba(0, 0, 0, 0.6)',
            'border-dim': 'rgba(255, 255, 255, 0.1)',
          },
          animation: {
            'pulse-glow': 'pulse-glow 2s ease-in-out infinite',
          },
          keyframes: {
            'pulse-glow': {
              '0%, 100%': { opacity: '1' },
              '50%': { opacity: '0.5' },
            }
          }
        }
      }
    }
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">

  <!-- Config Loader -->
  <script src="../assets/js/config-loader.js"></script>

  <!-- No fallback - config.json is the single source of truth -->

  <style>
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #050505; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #ccff00; }

    /* Scanlines */
    .scanlines {
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
      background-size: 100% 4px;
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      opacity: 0.6;
    }

    /* Noise */
    .noise {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9998;
      opacity: 0.03;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    }

    ::selection { background: #ccff00; color: #000; }

    /* Glass panel */
    .glass-panel {
      background: rgba(10, 10, 10, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Gallery view - full height */
    body.gallery-mode {
      height: 100vh;
      overflow: hidden;
    }

    /* Grid mode - scrollable */
    body.grid-mode {
      height: auto;
      overflow: auto;
    }

    /* Artwork frame */
    .artwork-frame {
      background: #0a0a0a;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
    }

    .artwork-frame img,
    .artwork-frame video {
      max-width: 90vw;
      max-height: 80vh;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    .artwork-frame--iframe {
      width: 90vw;
      max-width: 1200px;
      height: 80vh;
    }

    .artwork-frame--iframe .artwork-inner {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .artwork-frame--iframe iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Grid items */
    .grid-item {
      break-inside: avoid;
      margin-bottom: 1rem;
      transition: transform 0.3s ease;
    }
    .grid-item:hover {
      transform: translateY(-4px);
    }
    .grid-item img {
      width: 100%;
      height: auto;
      display: block;
      transition: filter 0.4s ease;
      filter: grayscale(30%);
    }
    .grid-item:hover img {
      filter: grayscale(0%);
    }

    /* Thoughts overlay */
    .thoughts-overlay {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .thoughts-overlay.is-visible {
      opacity: 1;
      pointer-events: auto;
    }

    /* Marquee for track titles */
    @keyframes scroll-title {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .scrolling {
      animation: scroll-title 12s linear infinite;
      display: inline-block;
    }
  </style>
</head>
<body class="bg-void text-gray-200 antialiased overflow-x-hidden selection:bg-acid selection:text-black grid-mode">
  <!-- Password protection removed -->

  <!-- Overlays -->
  <div class="scanlines"></div>
  <div class="noise"></div>

  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 z-50 px-6 py-4 flex justify-between items-start pointer-events-none mix-blend-difference text-white">
    <a href="../index.html" class="pointer-events-auto group cursor-pointer flex flex-col">
      <span class="font-display font-bold text-2xl tracking-tighter leading-none group-hover:text-acid transition-colors">con.rad</span>
      <span class="font-mono text-[10px] opacity-70 tracking-widest mt-1">BUILDING CURIOSITY...</span>
    </a>

    <nav class="pointer-events-auto hidden md:flex items-center gap-8 font-mono text-xs tracking-wider">
      <a href="../writings/index.html" class="hover:text-acid hover:underline underline-offset-4 decoration-acid">[ WRITINGS ]</a>
      <a href="../collection/index.html" class="hover:text-acid hover:underline underline-offset-4 decoration-acid">[ COLLECTION ]</a>
      <a href="../projects/index.html" class="hover:text-acid hover:underline underline-offset-4 decoration-acid">[ PROJECTS ]</a>
      <a href="https://www.are.na/conrad-house/visually-intriguing" target="_blank" class="hover:text-acid hover:underline underline-offset-4 decoration-acid">[ ARE.NA ]</a>
      <span class="w-2 h-2 rounded-full bg-acid animate-pulse-glow shadow-[0_0_10px_#ccff00]"></span>
    </nav>

    <button class="md:hidden pointer-events-auto text-acid">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="square" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  </header>

  <!-- Side Navigation (Gallery View) -->
  <nav class="side-nav fixed left-6 top-1/2 -translate-y-1/2 z-40 hidden" id="side-nav-prev">
    <button id="side-prev-btn" class="w-12 h-12 flex items-center justify-center text-white/30 hover:text-acid transition-colors">
      <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    </button>
  </nav>
  <nav class="side-nav fixed right-6 top-1/2 -translate-y-1/2 z-40 hidden" id="side-nav-next">
    <button id="side-next-btn" class="w-12 h-12 flex items-center justify-center text-white/30 hover:text-acid transition-colors">
      <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    </button>
  </nav>

  <!-- Counter -->
  <div class="fixed bottom-6 left-1/2 -translate-x-1/2 font-mono text-xs text-white/40 z-40 hidden" id="gallery-counter">1 / 1</div>

  <!-- Gallery View (Single Artwork) -->
  <main class="hidden h-screen items-center justify-center pt-20" id="gallery-main">
    <div class="artwork-container flex flex-col items-center" id="artwork-container">
      <div class="artwork-frame" id="artwork-frame">
        <div class="artwork-inner relative" id="artwork-inner">
          <div class="artwork-loading absolute inset-0 flex items-center justify-center bg-void text-gray-500 font-mono text-xs uppercase tracking-widest z-10" id="artwork-loading">Loading</div>
        </div>
      </div>

      <!-- Plaque -->
      <div class="glass-panel fixed bottom-8 left-8 max-w-xs p-4 z-40" id="artwork-plaque">
        <h1 class="font-display text-lg font-bold mb-1" id="plaque-title">Untitled</h1>
        <p class="font-mono text-xs text-gray-400" id="plaque-artist"></p>
        <p class="font-mono text-[10px] text-gray-500 mt-2" id="plaque-medium">Digital Art</p>
      </div>

      <!-- Sidebar Description -->
      <aside class="fixed top-1/2 right-16 -translate-y-1/2 max-w-[220px] max-h-[50vh] overflow-y-auto z-40 hidden" id="artwork-sidebar">
        <div class="glass-panel p-4">
          <p class="font-mono text-[10px] text-acid uppercase tracking-widest mb-2">thoughts.</p>
          <p class="font-sans text-sm text-gray-300 leading-relaxed" id="sidebar-text"></p>
        </div>
      </aside>
    </div>

    <!-- Empty State -->
    <div class="hidden flex-col items-center justify-center text-gray-500" id="gallery-empty">
      <svg class="w-16 h-16 mb-4 opacity-30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <circle cx="8.5" cy="8.5" r="1.5"/>
        <path d="M21 15l-5-5L5 21"/>
      </svg>
      <p class="font-mono text-xs uppercase tracking-widest">No artwork to display</p>
    </div>
  </main>

  <!-- Grid View -->
  <section class="relative z-10 pt-32 pb-48 px-4 md:px-8 max-w-7xl mx-auto" id="gallery-grid">
    <!-- Grid Header -->
    <div class="glass-panel p-8 mb-8 rounded-sm">
      <div class="flex items-end justify-between gap-4">
        <h1 class="font-display text-4xl md:text-5xl font-bold uppercase">Collection</h1>
        <p class="font-sans text-gray-400 text-right">collection of thoughts around my collection.</p>
      </div>
    </div>

    <!-- Grid -->
    <div class="columns-1 sm:columns-2 lg:columns-3 xl:columns-4 gap-4" id="gallery-grid-inner">
      <!-- Populated by JS -->
    </div>
  </section>

  <!-- View Controls -->
  <div class="fixed bottom-6 right-6 flex gap-2 z-40" id="view-controls">
    <button class="glass-panel w-10 h-10 flex items-center justify-center text-gray-400 hover:text-acid hover:border-acid transition-all" id="grid-btn" title="Toggle grid view">
      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
        <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
      </svg>
    </button>
    <button class="glass-panel w-10 h-10 flex items-center justify-center text-gray-400 hover:text-acid hover:border-acid transition-all hidden" id="fullscreen-btn" title="Toggle fullscreen">
      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
      </svg>
    </button>
    <a class="glass-panel w-10 h-10 flex items-center justify-center text-gray-400 hover:text-acid hover:border-acid transition-all hidden" id="external-btn" href="#" target="_blank" title="Open in new tab">
      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
        <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
      </svg>
    </a>
  </div>

  <!-- Footer -->
  <footer class="relative z-10 border-t border-white/10 bg-black/80 backdrop-blur-md py-12">
    <div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-end gap-6">
      <div>
        <h3 class="font-display text-2xl mb-2">con.rad</h3>
        <p class="font-mono text-xs text-gray-500">© <span id="current-year"></span> conrad house. curiously tinkering and breaking things.</p>
      </div>
      <div class="flex gap-6 font-mono text-xs">
        <a href="https://github.com/nemocake" target="_blank" class="hover:text-acid hover:underline">GITHUB</a>
        <a href="https://x.com/DlSPUTED" target="_blank" class="hover:text-acid hover:underline">TWITTER/X</a>
      </div>
    </div>
  </footer>

  <!-- Winamp-style Music Player -->
  <div id="y2k-player" class="fixed left-6 z-50 w-72 glass-panel border-t-2 border-t-white/20 shadow-2xl" style="bottom: 180px;">
    <!-- Title bar -->
    <div class="bg-gradient-to-r from-gray-800 to-gray-900 p-1 flex justify-between items-center cursor-move border-b border-black" id="player-drag-handle">
      <div class="flex gap-1 ml-1">
        <div class="w-2 h-2 rounded-full bg-red-500"></div>
        <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
        <div class="w-2 h-2 rounded-full bg-green-500"></div>
      </div>
      <div class="font-mono text-[9px] uppercase tracking-widest text-gray-400 mr-2">Winamp_v2.9</div>
    </div>

    <!-- Player body -->
    <div class="p-4 bg-void/90">
      <!-- LCD Display -->
      <div class="bg-black border-2 border-gray-700 rounded-sm p-2 mb-3 shadow-[inset_0_0_10px_rgba(0,0,0,1)]">
        <div class="font-mono text-acid text-xs whitespace-nowrap overflow-hidden">
          <div id="y2k-track-title" class="inline-block">Press play to start</div>
        </div>
        <div class="flex justify-between font-mono text-[10px] text-acid mt-1">
          <span id="y2k-current-time">0:00</span>
          <span id="y2k-status-text" class="animate-pulse">Ready</span>
          <span id="y2k-duration">0:00</span>
        </div>
      </div>

      <!-- Equalizer bars -->
      <div class="flex items-end h-8 gap-[2px] mb-3 opacity-80">
        <div class="w-full bg-acid/20 h-full relative overflow-hidden">
          <div class="absolute bottom-0 w-[10%] left-[0%] bg-acid h-[40%] animate-pulse"></div>
          <div class="absolute bottom-0 w-[10%] left-[12%] bg-acid h-[70%] animate-pulse" style="animation-delay: 0.1s"></div>
          <div class="absolute bottom-0 w-[10%] left-[24%] bg-acid h-[30%] animate-pulse" style="animation-delay: 0.3s"></div>
          <div class="absolute bottom-0 w-[10%] left-[36%] bg-acid h-[90%] animate-pulse" style="animation-delay: 0.05s"></div>
          <div class="absolute bottom-0 w-[10%] left-[48%] bg-acid h-[50%] animate-pulse" style="animation-delay: 0.2s"></div>
          <div class="absolute bottom-0 w-[10%] left-[60%] bg-acid h-[80%] animate-pulse" style="animation-delay: 0.4s"></div>
          <div class="absolute bottom-0 w-[10%] left-[72%] bg-acid h-[20%] animate-pulse" style="animation-delay: 0.15s"></div>
          <div class="absolute bottom-0 w-[10%] left-[84%] bg-acid h-[60%] animate-pulse" style="animation-delay: 0.25s"></div>
        </div>
      </div>

      <!-- Progress bar -->
      <div id="y2k-progress" class="w-full h-2 bg-gray-800 rounded cursor-pointer mb-3 relative">
        <div id="y2k-progress-bar" class="h-full bg-acid rounded transition-all" style="width: 0%"></div>
        <div id="y2k-progress-handle" class="absolute top-1/2 -translate-y-1/2 w-2 h-2 bg-white rounded-full" style="left: 0%"></div>
      </div>

      <!-- Controls -->
      <div class="flex justify-between items-center">
        <div class="flex gap-2">
          <button id="y2k-prev" class="text-gray-400 hover:text-white text-xs">⏮</button>
          <button id="y2k-play" class="text-acid hover:text-white text-base"><span id="y2k-play-icon">▶</span></button>
          <button id="y2k-next" class="text-gray-400 hover:text-white text-xs">⏭</button>
          <button id="y2k-stop" class="text-gray-400 hover:text-white text-xs">⏹</button>
        </div>
        <div class="flex items-center gap-2">
          <button id="y2k-shuffle" class="text-gray-400 hover:text-acid text-[10px] font-mono transition-colors" title="Shuffle">SHF</button>
          <button id="y2k-playlist-toggle" class="text-gray-400 hover:text-acid text-[10px] font-mono transition-colors" title="Playlist">LST</button>
          <div id="y2k-volume" class="w-12 h-1 bg-gray-700 rounded-full cursor-pointer">
            <div id="y2k-volume-bar" class="w-3/4 h-full bg-acid rounded-full"></div>
          </div>
        </div>
      </div>

      <!-- Playlist Panel -->
      <div id="y2k-playlist" class="hidden mt-3 border-t border-gray-700 pt-3 max-h-40 overflow-y-auto">
        <div class="font-mono text-[9px] text-gray-500 uppercase tracking-widest mb-2">Playlist</div>
        <div id="y2k-playlist-items" class="space-y-1">
          <div class="text-gray-500 text-xs font-mono">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Hidden YouTube player -->
    <div id="y2k-yt-container" style="position:absolute;left:-9999px;top:0;width:200px;height:200px;overflow:hidden;pointer-events:none;">
      <div id="y2k-yt-player"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    document.getElementById('current-year').textContent = new Date().getFullYear();

    // Position player above plaque
    function positionPlayerAbovePlaque() {
      const plaque = document.getElementById('artwork-plaque');
      const player = document.getElementById('y2k-player');
      if (!plaque || !player) return;

      const plaqueRect = plaque.getBoundingClientRect();
      const plaqueBottom = window.innerHeight - plaqueRect.top;
      const gap = 16; // 16px gap between plaque and player
      player.style.bottom = (plaqueBottom + gap) + 'px';
    }

    // Run on load and when artwork changes
    window.addEventListener('load', () => setTimeout(positionPlayerAbovePlaque, 100));
    window.addEventListener('resize', positionPlayerAbovePlaque);

    // Player drag functionality
    const player = document.getElementById('y2k-player');
    let isDragging = false, currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

    document.getElementById('player-drag-handle').addEventListener("mousedown", (e) => {
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;
      isDragging = true;
    });
    document.addEventListener("mouseup", () => { initialX = currentX; initialY = currentY; isDragging = false; });
    document.addEventListener("mousemove", (e) => {
      if (isDragging) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        xOffset = currentX;
        yOffset = currentY;
        player.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
      }
    });
  </script>

  <!-- Gallery Controller -->
  <script>
    (function() {
      let collection = [];
      let currentIndex = 0;
      let isGridMode = true;

      // DOM Elements
      const galleryMain = document.getElementById('gallery-main');
      const galleryGrid = document.getElementById('gallery-grid');
      const artworkFrame = document.getElementById('artwork-frame');
      const artworkInner = document.getElementById('artwork-inner');
      const artworkLoading = document.getElementById('artwork-loading');
      const plaqueTitle = document.getElementById('plaque-title');
      const plaqueArtist = document.getElementById('plaque-artist');
      const plaqueMedium = document.getElementById('plaque-medium');
      const artworkPlaque = document.getElementById('artwork-plaque');
      const artworkSidebar = document.getElementById('artwork-sidebar');
      const sidebarText = document.getElementById('sidebar-text');
      const galleryEmpty = document.getElementById('gallery-empty');
      const gridInner = document.getElementById('gallery-grid-inner');
      const sideNavPrev = document.getElementById('side-nav-prev');
      const sideNavNext = document.getElementById('side-nav-next');
      const sidePrevBtn = document.getElementById('side-prev-btn');
      const sideNextBtn = document.getElementById('side-next-btn');
      const galleryCounter = document.getElementById('gallery-counter');
      const gridBtn = document.getElementById('grid-btn');
      const fullscreenBtn = document.getElementById('fullscreen-btn');
      const externalBtn = document.getElementById('external-btn');
      const viewControls = document.getElementById('view-controls');

      function init() {
        // Check URL params
        const params = new URLSearchParams(window.location.search);
        const hasIndex = params.has('index');
        if (hasIndex) {
          currentIndex = parseInt(params.get('index'), 10) || 0;
          isGridMode = false;
        } else if (params.get('view') === 'grid') {
          isGridMode = true;
        }

        // Events
        sidePrevBtn.addEventListener('click', () => navigate(-1));
        sideNextBtn.addEventListener('click', () => navigate(1));
        gridBtn.addEventListener('click', toggleGridMode);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        document.addEventListener('keydown', handleKeyboard);
      }

      function loadCollection(items) {
        collection = items;
        console.log('[Collection] Loaded', collection.length, 'items');

        if (collection.length === 0) {
          showEmptyState();
          return;
        }

        currentIndex = Math.max(0, Math.min(currentIndex, collection.length - 1));
        buildGrid();

        if (isGridMode) {
          showGridMode();
        } else {
          showGalleryMode();
          displayArtwork(currentIndex);
        }
      }

      function showEmptyState() {
        galleryMain.classList.remove('hidden');
        galleryMain.classList.add('flex');
        galleryGrid.style.display = 'none';
        document.getElementById('artwork-container').style.display = 'none';
        galleryEmpty.classList.remove('hidden');
        galleryEmpty.classList.add('flex');
      }

      function showGridMode() {
        document.body.classList.add('grid-mode');
        document.body.classList.remove('gallery-mode');
        galleryMain.classList.add('hidden');
        galleryMain.classList.remove('flex');
        galleryGrid.style.display = 'block';
        sideNavPrev.classList.add('hidden');
        sideNavNext.classList.add('hidden');
        galleryCounter.classList.add('hidden');
        fullscreenBtn.classList.add('hidden');
        externalBtn.classList.add('hidden');
        gridBtn.classList.remove('bg-acid', 'text-black');
      }

      function showGalleryMode() {
        document.body.classList.remove('grid-mode');
        document.body.classList.add('gallery-mode');
        galleryMain.classList.remove('hidden');
        galleryMain.classList.add('flex');
        galleryGrid.style.display = 'none';
        if (collection.length > 1) {
          sideNavPrev.classList.remove('hidden');
          sideNavNext.classList.remove('hidden');
          galleryCounter.classList.remove('hidden');
        }
        fullscreenBtn.classList.remove('hidden');
        externalBtn.classList.remove('hidden');
        gridBtn.classList.add('bg-acid', 'text-black');
      }

      function displayArtwork(index) {
        const item = collection[index];
        if (!item) return;

        artworkLoading.style.display = 'flex';
        const url = item.render || item.thumbnail || item.link || item.image;

        // Determine type
        let isVideo = item.type === 'video';
        let isIframe = item.type === 'iframe';
        if (!item.type) {
          const videoExt = ['.mp4', '.webm', '.mov', '.ogg'];
          isVideo = videoExt.some(ext => url.toLowerCase().includes(ext));
          isIframe = !isVideo && (url.endsWith('.html') || url.includes('/index.html'));
        }

        // Clear previous
        const existing = artworkInner.querySelector('iframe, img, video');
        if (existing) existing.remove();
        artworkFrame.classList.remove('artwork-frame--iframe');

        if (isVideo) {
          const video = document.createElement('video');
          video.src = url;
          video.controls = true;
          video.loop = true;
          video.muted = true;
          video.playsInline = true;
          video.onloadeddata = () => { artworkLoading.style.display = 'none'; video.play().catch(() => {}); };
          artworkInner.appendChild(video);
        } else if (isIframe) {
          artworkFrame.classList.add('artwork-frame--iframe');
          const iframe = document.createElement('iframe');
          iframe.src = url;
          iframe.allow = 'autoplay; fullscreen';
          iframe.setAttribute('scrolling', 'no');
          iframe.onload = () => { artworkLoading.style.display = 'none'; };
          artworkInner.appendChild(iframe);
        } else {
          const img = document.createElement('img');
          img.src = url;
          img.alt = item.title || 'Artwork';
          img.onload = () => { artworkLoading.style.display = 'none'; };
          artworkInner.appendChild(img);
        }

        // Update plaque
        plaqueTitle.textContent = item.title || 'Untitled';
        plaqueArtist.textContent = item.artist || '';
        plaqueArtist.style.display = item.artist ? 'block' : 'none';
        plaqueMedium.textContent = item.medium || (isIframe ? 'Generative Art' : 'Digital Art');
        externalBtn.href = url;

        // Sidebar
        if (item.description) {
          sidebarText.textContent = item.description;
          artworkSidebar.classList.remove('hidden');
        } else {
          artworkSidebar.classList.add('hidden');
        }

        // Counter
        galleryCounter.textContent = (index + 1) + ' / ' + collection.length;
        sidePrevBtn.disabled = index === 0;
        sideNextBtn.disabled = index === collection.length - 1;
        document.title = (item.title || 'Artwork') + ' | Collection | con.rad';

        // Reposition player above plaque after content updates
        setTimeout(positionPlayerAbovePlaque, 50);
      }

      function navigate(direction) {
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < collection.length) {
          currentIndex = newIndex;
          displayArtwork(currentIndex);
          const url = new URL(window.location);
          url.searchParams.set('index', currentIndex);
          history.replaceState(null, '', url);
        }
      }

      function toggleGridMode() {
        isGridMode = !isGridMode;
        if (isGridMode) {
          showGridMode();
          const url = new URL(window.location);
          url.searchParams.delete('index');
          url.searchParams.set('view', 'grid');
          history.replaceState(null, '', url);
        } else {
          showGalleryMode();
          displayArtwork(currentIndex);
          const url = new URL(window.location);
          url.searchParams.set('index', currentIndex);
          url.searchParams.delete('view');
          history.replaceState(null, '', url);
        }
      }

      function toggleFullscreen() {
        document.body.classList.toggle('fullscreen-mode');
      }

      function buildGrid() {

        gridInner.innerHTML = collection.map((item, index) => {
          const hasThoughts = item.description && item.description.trim().length > 0;
          const isVideo = item.type === 'video';
          const badge = isVideo ? `<div class="absolute top-3 right-3 w-7 h-7 bg-black/60 rounded-full flex items-center justify-center"><svg class="w-3 h-3 text-white" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg></div>` : '';

          return `
            <div class="grid-item glass-panel overflow-hidden cursor-pointer relative group" data-index="${index}">
              <img src="${item.thumbnail || item.image}" alt="${item.title || ''}" loading="lazy" class="w-full">
              ${badge}
              ${hasThoughts ? `<button class="thoughts-btn absolute top-3 left-3 px-2 py-1 bg-black/70 backdrop-blur text-[10px] font-mono text-white/90 opacity-0 group-hover:opacity-100 transition-opacity z-10" data-thoughts-trigger>thoughts</button>` : ''}
              <div class="absolute inset-x-0 bottom-0 p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                <h3 class="font-display text-sm font-bold">${item.title || 'Untitled'}</h3>
                ${item.artist ? `<p class="font-mono text-xs text-gray-400">${item.artist}</p>` : ''}
              </div>
              ${hasThoughts ? `
                <div class="thoughts-overlay absolute inset-0 bg-black/95 p-5 flex flex-col justify-center z-20">
                  <button class="absolute top-3 right-3 w-7 h-7 bg-white/10 rounded-full flex items-center justify-center text-white/70 hover:text-white" data-thoughts-close>×</button>
                  <p class="font-mono text-[10px] text-acid uppercase tracking-widest mb-2">thoughts.</p>
                  <p class="font-sans text-sm text-gray-200 leading-relaxed">${item.description}</p>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');

        // Click handlers
        gridInner.querySelectorAll('.grid-item').forEach(item => {
          item.addEventListener('click', (e) => {
            if (e.target.closest('[data-thoughts-trigger]') || e.target.closest('.thoughts-overlay')) return;
            currentIndex = parseInt(item.dataset.index, 10);
            isGridMode = false;
            showGalleryMode();
            displayArtwork(currentIndex);
            const url = new URL(window.location);
            url.searchParams.set('index', currentIndex);
            url.searchParams.delete('view');
            history.replaceState(null, '', url);
            window.scrollTo(0, 0);
          });
        });

        gridInner.querySelectorAll('[data-thoughts-trigger]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const overlay = btn.closest('.grid-item').querySelector('.thoughts-overlay');
            if (overlay) overlay.classList.add('is-visible');
          });
        });

        gridInner.querySelectorAll('[data-thoughts-close]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            btn.closest('.thoughts-overlay').classList.remove('is-visible');
          });
        });
      }

      function handleKeyboard(e) {
        if (!isGridMode) {
          if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') navigate(-1);
          else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') navigate(1);
        }
        if (e.key === 'Escape') {
          if (document.body.classList.contains('fullscreen-mode')) {
            document.body.classList.remove('fullscreen-mode');
          } else if (!isGridMode) {
            toggleGridMode();
          }
        }
        if ((e.key === 'f' || e.key === 'F') && !isGridMode) toggleFullscreen();
        if (e.key === 'g' || e.key === 'G') toggleGridMode();
      }

      init();

      // Load collection from config.json - no fallbacks
      if (window.SITE_CONFIG && window.SITE_CONFIG.collection && window.SITE_CONFIG.collection.length > 0) {
        loadCollection(window.SITE_CONFIG.collection);
      } else {
        // Wait for config to load
        console.log('[Collection] Waiting for config...');
        window.addEventListener('configLoaded', (e) => {
          const config = e.detail;
          if (config && config.collection && config.collection.length > 0) {
            loadCollection(config.collection);
          } else {
            console.error('[Collection] Config loaded but no collection found');
            showEmptyState();
          }
        });

        // Timeout - if config doesn't load in 5 seconds, show error
        setTimeout(() => {
          if (collection.length === 0) {
            console.error('[Collection] Config failed to load');
            showEmptyState();
          }
        }, 5000);
      }
    })();
  </script>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <!-- Y2K Player Controller -->
  <script>
    (function initY2KPlayer() {
      const PLAYLIST_ID = 'PLGl_0guG9m0iKPAfhpooMWA0zKESKkYN4';

      const statusText = document.getElementById('y2k-status-text');
      const trackTitle = document.getElementById('y2k-track-title');
      const currentTimeEl = document.getElementById('y2k-current-time');
      const durationEl = document.getElementById('y2k-duration');
      const progressBar = document.getElementById('y2k-progress-bar');
      const progressHandle = document.getElementById('y2k-progress-handle');
      const progress = document.getElementById('y2k-progress');
      const volumeBar = document.getElementById('y2k-volume-bar');
      const volume = document.getElementById('y2k-volume');
      const playBtn = document.getElementById('y2k-play');
      const playIcon = document.getElementById('y2k-play-icon');
      const stopBtn = document.getElementById('y2k-stop');
      const prevBtn = document.getElementById('y2k-prev');
      const nextBtn = document.getElementById('y2k-next');
      const shuffleBtn = document.getElementById('y2k-shuffle');
      const playlistToggle = document.getElementById('y2k-playlist-toggle');
      const playlistPanel = document.getElementById('y2k-playlist');
      const playlistItems = document.getElementById('y2k-playlist-items');

      let ytPlayer = null;
      let progressInterval = null;
      let isReady = false;
      let isShuffled = false;

      function formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      function updateProgress() {
        if (!ytPlayer || !isReady) return;
        try {
          const current = ytPlayer.getCurrentTime() || 0;
          const duration = ytPlayer.getDuration() || 1;
          const percent = (current / duration) * 100;
          progressBar.style.width = percent + '%';
          progressHandle.style.left = percent + '%';
          currentTimeEl.textContent = formatTime(current);
          durationEl.textContent = formatTime(duration);
        } catch (e) {}
      }

      function setStatus(state) {
        if (state === 'playing') {
          statusText.textContent = 'Playing';
          playIcon.textContent = '⏸';
        } else if (state === 'paused') {
          statusText.textContent = 'Paused';
          playIcon.textContent = '▶';
        } else {
          statusText.textContent = 'Ready';
          playIcon.textContent = '▶';
        }
      }

      function createPlayer() {
        if (ytPlayer) return;
        ytPlayer = new YT.Player('y2k-yt-player', {
          height: '200', width: '200',
          playerVars: { autoplay: 0, controls: 0, disablekb: 1, fs: 0, modestbranding: 1, rel: 0, origin: window.location.origin, listType: 'playlist', list: PLAYLIST_ID },
          events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange, onError: onPlayerError }
        });
      }

      window.onYouTubeIframeAPIReady = function() { createPlayer(); };
      if (typeof YT !== 'undefined' && YT.Player) createPlayer();

      function onPlayerReady(event) {
        isReady = true;
        setStatus('stopped');
        trackTitle.textContent = 'Press play to start';
        ytPlayer.setVolume(70);
        volumeBar.style.width = '70%';
        try { ytPlayer.setLoop(true); } catch (e) {}
        setTimeout(updateTrackInfo, 1000);
      }

      function onPlayerStateChange(event) {
        clearInterval(progressInterval);
        switch (event.data) {
          case YT.PlayerState.PLAYING:
            setStatus('playing');
            updateTrackInfo();
            setTimeout(storeCurrentTitle, 500);
            progressInterval = setInterval(updateProgress, 500);
            break;
          case YT.PlayerState.PAUSED:
            setStatus('paused');
            updateTrackInfo();
            break;
          case YT.PlayerState.ENDED:
          case YT.PlayerState.CUED:
            setStatus('stopped');
            if (event.data === YT.PlayerState.CUED) { updateTrackInfo(); ytPlayer.playVideo(); }
            break;
          case YT.PlayerState.BUFFERING:
            statusText.textContent = 'Loading...';
            setTimeout(updateTrackInfo, 300);
            break;
          default:
            setStatus('stopped');
        }
      }

      function onPlayerError(event) {
        trackTitle.textContent = 'Skipping...';
        setStatus('stopped');
        setTimeout(() => { if (ytPlayer && isReady) ytPlayer.nextVideo(); }, 1500);
      }

      function updateTrackInfo() {
        if (!ytPlayer || !isReady) return;
        try {
          const data = ytPlayer.getVideoData();
          if (data && data.title) setTrackTitle(data.title);
          else setTrackTitle('Loading...');
        } catch (e) { setTrackTitle('YouTube Playlist'); }
      }

      function setTrackTitle(title) {
        const container = trackTitle.parentElement;
        const maxWidth = container ? container.offsetWidth : 200;
        const span = document.createElement('span');
        span.style.cssText = 'position:absolute;visibility:hidden;white-space:nowrap;font-size:0.75rem;';
        span.textContent = title;
        document.body.appendChild(span);
        const textWidth = span.offsetWidth;
        document.body.removeChild(span);
        if (textWidth > maxWidth - 10) {
          trackTitle.innerHTML = title + '<span style="padding:0 30px;">•</span>' + title;
          trackTitle.classList.add('scrolling');
        } else {
          trackTitle.textContent = title;
          trackTitle.classList.remove('scrolling');
        }
      }

      playBtn?.addEventListener('click', () => {
        if (!ytPlayer || !isReady) { trackTitle.textContent = 'Loading player...'; return; }
        const state = ytPlayer.getPlayerState();
        if (state === YT.PlayerState.PLAYING) ytPlayer.pauseVideo();
        else { statusText.textContent = 'Loading...'; ytPlayer.playVideo(); }
      });

      stopBtn?.addEventListener('click', () => {
        if (!ytPlayer || !isReady) return;
        ytPlayer.stopVideo();
        progressBar.style.width = '0%';
        progressHandle.style.left = '0%';
        currentTimeEl.textContent = '0:00';
        setStatus('stopped');
      });

      prevBtn?.addEventListener('click', () => {
        if (!ytPlayer || !isReady) return;
        trackTitle.textContent = 'Loading...';
        statusText.textContent = 'Loading...';
        try {
          const playlist = ytPlayer.getPlaylist();
          const index = ytPlayer.getPlaylistIndex();
          if (index === 0 && playlist && playlist.length > 0) ytPlayer.playVideoAt(playlist.length - 1);
          else ytPlayer.previousVideo();
        } catch (e) {}
      });

      nextBtn?.addEventListener('click', () => {
        if (!ytPlayer || !isReady) return;
        trackTitle.textContent = 'Loading...';
        statusText.textContent = 'Loading...';
        try {
          const playlist = ytPlayer.getPlaylist();
          const index = ytPlayer.getPlaylistIndex();
          if (playlist && index >= playlist.length - 1) ytPlayer.playVideoAt(0);
          else ytPlayer.nextVideo();
        } catch (e) {}
      });

      progress?.addEventListener('click', (e) => {
        if (!ytPlayer || !isReady) return;
        const rect = progress.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        ytPlayer.seekTo(percent * ytPlayer.getDuration(), true);
      });

      volume?.addEventListener('click', (e) => {
        if (!ytPlayer || !isReady) return;
        const rect = volume.getBoundingClientRect();
        const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
        ytPlayer.setVolume(percent * 100);
        volumeBar.style.width = (percent * 100) + '%';
      });

      // Playlist toggle
      playlistToggle?.addEventListener('click', () => {
        playlistPanel.classList.toggle('hidden');
        if (!playlistPanel.classList.contains('hidden')) {
          renderPlaylist();
        }
      });

      // Shuffle toggle
      shuffleBtn?.addEventListener('click', () => {
        if (!ytPlayer || !isReady) return;
        isShuffled = !isShuffled;
        ytPlayer.setShuffle(isShuffled);
        shuffleBtn.classList.toggle('text-acid', isShuffled);
        shuffleBtn.classList.toggle('text-gray-400', !isShuffled);
      });

      // Store track titles
      let trackTitles = {};
      let titlesFetched = false;

      // Fetch all track titles from YouTube oEmbed
      async function fetchAllTitles() {
        if (titlesFetched || !ytPlayer || !isReady) return;
        const playlist = ytPlayer.getPlaylist();
        if (!playlist || playlist.length === 0) return;

        titlesFetched = true;

        // Fetch titles in parallel
        const promises = playlist.map(async (videoId, idx) => {
          try {
            const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
            if (response.ok) {
              const data = await response.json();
              trackTitles[idx] = data.title;
            }
          } catch (e) {
            // Keep default title on error
          }
        });

        await Promise.all(promises);

        // Re-render playlist with fetched titles
        if (!playlistPanel.classList.contains('hidden')) {
          renderPlaylist();
        }
      }

      // Render playlist
      function renderPlaylist() {
        if (!ytPlayer || !isReady) return;
        try {
          const playlist = ytPlayer.getPlaylist();
          const currentIdx = ytPlayer.getPlaylistIndex();
          if (!playlist || playlist.length === 0) {
            playlistItems.innerHTML = '<div class="text-gray-500 text-xs font-mono">No tracks</div>';
            return;
          }

          // Fetch titles if not already done
          if (!titlesFetched) fetchAllTitles();

          // Store current track title as fallback
          const currentTitle = ytPlayer.getVideoData()?.title;
          if (currentTitle) trackTitles[currentIdx] = currentTitle;

          playlistItems.innerHTML = playlist.map((videoId, idx) => {
            const title = trackTitles[idx] || `Loading...`;
            return `
            <div class="playlist-item flex items-center gap-2 py-1 px-2 rounded cursor-pointer hover:bg-white/5 transition-colors ${idx === currentIdx ? 'bg-acid/10 text-acid' : 'text-gray-400'}" data-index="${idx}">
              <span class="text-[10px] font-mono w-4 opacity-50">${String(idx + 1).padStart(2, '0')}</span>
              <span class="text-xs font-mono truncate flex-1">${title}</span>
            </div>
          `}).join('');

          // Add click handlers
          playlistItems.querySelectorAll('.playlist-item').forEach(item => {
            item.addEventListener('click', () => {
              const idx = parseInt(item.dataset.index, 10);
              ytPlayer.playVideoAt(idx);
              setTimeout(() => renderPlaylist(), 500);
            });
          });
        } catch (e) {
          playlistItems.innerHTML = '<div class="text-gray-500 text-xs font-mono">Error loading playlist</div>';
        }
      }

      // Update stored title when track changes
      function storeCurrentTitle() {
        if (!ytPlayer || !isReady) return;
        const idx = ytPlayer.getPlaylistIndex();
        const title = ytPlayer.getVideoData()?.title;
        if (title && idx >= 0) {
          trackTitles[idx] = title;
          if (!playlistPanel.classList.contains('hidden')) {
            renderPlaylist();
          }
        }
      }
    })();
  </script>
</body>
</html>
